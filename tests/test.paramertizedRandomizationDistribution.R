################################################################################
# Test of the pRD() function. Many other tests of this function in other test.*
# files. This is a place for tests that don't have a home there.
################################################################################

library(testthat)
context("paramertizedRandomizationDistribution")

test_that("Engine and pRD give same answers", {
  
  # data borrowed from wilcox test
  set.seed(20110620)
  tau <- 10
  n <- 8 
  Yc <- rnorm(n)
  Yt <- Yc + tau
  Z <- rep(0, n)
  Z[sample.int(n, n/2)] <- 1
  R <- Z * Yt + (1 - Z) * Yc

  constant.additive.fn <- function(ys, z, b, tau) {
    ys - (z * tau)
  } 
  set.seed(20110620)
  res.prd <- parameterizedRandomizationDistribution(R, Z, mann.whitney.u, 
    constant.additive.fn, list(tau = c(-10, 9, 10)))

  # being extra explicit about model creation
  mm10 <- function(y, z, b) { constant.additive.fn(y, z, b, -10) }
  m9 <- function(y, z, b) { constant.additive.fn(y, z, b, 9) }
  m10 <- function(y, z, b) { constant.additive.fn(y, z, b, 10) }
  
  set.seed(20110620)
  res.eng <- randomizationDistributionEngine(R, Z, list(list(mann.whitney.u, mm10, m9, m10)))

  # prd has some extra information, and we don't expect that to be the same
  # also, the return value of res.eng is a list, so we pull out the first item, just as pRD does.
  expect_identical(res.prd@.Data, res.eng[[1]]@.Data)

})

test_that("Using model objects", {
  # constant.additive.model is already defined
  set.seed(20110620)
  tau <- 10
  n <- 8 
  Yc <- rnorm(n)
  Yt <- Yc + tau
  Z <- rep(0, n)
  Z[sample.int(n, n/2)] <- 1
  R <- Z * Yt + (1 - Z) * Yc

  function.version <- function(...) {
    modelOfEffect(constant.additive.model, ...)  
  }

  hypotheses <-  list(tau = c(7,8,9,10,11,12))
  res.fn <- parameterizedRandomizationDistribution(R, Z, mean.diff.noblocks,
    function.version, parameters = hypotheses)

  res.model <- parameterizedRandomizationDistribution(R, Z, mean.diff.noblocks,
    constant.additive.model, parameters = hypotheses)
  
})

test_that("Moe can be NULL", {
  set.seed(20110620)
  tau <- 10
  n <- 8 
  Yc <- rnorm(n)
  Yt <- Yc + tau
  Z <- rep(0, n)
  Z[sample.int(n, n/2)] <- 1
  R <- Z * Yt + (1 - Z) * Yc

  # this should not raise an error
  res.prd <- parameterizedRandomizationDistribution(R, Z, mean.diff.noblocks)
  
})

