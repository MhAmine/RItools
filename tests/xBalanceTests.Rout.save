
R version 3.2.1 (2015-06-18) -- "World-Famous Astronaut"
Copyright (C) 2015 The R Foundation for Statistical Computing
Platform: x86_64-unknown-linux-gnu (64-bit)

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> require("RItools")
Loading required package: RItools
Loading required package: survival
> 
> data(nuclearplants)
> 
> ##################################################
> ### Basic uses
> ##################################################
> xBalance(pr~ date + t1 + t2 + cap + ne + ct + bw + cum.n, data=nuclearplants)
      strata  Unstrat        
      stat   std.diff       z
vars                         
date          -0.1147 -0.3052
t1             0.1063  0.2830
t2             1.0327  2.4674
cap            0.3401  0.8948
ne            -0.1631 -0.4334
ct            -0.3080 -0.8121
bw             0.0451  0.1202
cum.n         -0.0976 -0.2598
> 
> xBalance(pr~ date + t1 + t2 + cap + ne + ct + bw + cum.n, data=nuclearplants,
+          report=c("adj.means","adj.mean.diffs",'std.diffs', 'z.scores', 'chisquare.test'))
      strata   Unstrat                                    
      stat   Treatment  Control adj.diff std.diff        z
vars                                                      
date           68.5000  68.6182  -0.1182  -0.1147  -0.3052
t1             14.0000  13.6364   0.3636   0.1063   0.2830
t2             69.1000  59.3182   9.7818   1.0327   2.4674
cap           869.8000 805.1818  64.6182   0.3401   0.8948
ne              0.2000   0.2727  -0.0727  -0.1631  -0.4334
ct              0.3000   0.4545  -0.1545  -0.3080  -0.8121
bw              0.2000   0.1818   0.0182   0.0451   0.1202
cum.n           8.1000   8.7273  -0.6273  -0.0976  -0.2598
---Overall Test---
chisquare        df   p.value 
 "11.463"  " 8.000"  " 0.177" 
> 
> xBalance(pr~ date + t1 + t2 + cap + ne + ct + bw + cum.n + strata(pt),
+          data=nuclearplants,
+          report=c("adj.means","adj.mean.diffs",'std.diffs', 'z.scores', 'chisquare.test'))
      strata        pt                                       Unstrat                                    
      stat   Treatment  Control adj.diff std.diff        z Treatment  Control adj.diff std.diff        z
vars                                                                                                    
date           68.5000  68.4924   0.0979   0.0950   0.2923   68.5000  68.6182  -0.1182  -0.1147  -0.3052
t1             14.0000  13.3953   0.9535   0.2787   0.7918   14.0000  13.6364   0.3636   0.1063   0.2830
t2             69.1000  59.1802   9.3721   0.9894   2.3094   69.1000  59.3182   9.7818   1.0327   2.4674
cap           869.8000 806.4535  66.5698   0.3504   0.9188  869.8000 805.1818  64.6182   0.3401   0.8948
ne              0.2000   0.2442  -0.0233  -0.0522  -0.1445    0.2000   0.2727  -0.0727  -0.1631  -0.4334
ct              0.3000   0.4419  -0.1105  -0.2201  -0.5828    0.3000   0.4545  -0.1545  -0.3080  -0.8121
bw              0.2000   0.1977  -0.0465  -0.1154  -0.3088    0.2000   0.1818   0.0182   0.0451   0.1202
cum.n           8.1000   8.7209  -0.8198  -0.1275  -0.3397    8.1000   8.7273  -0.6273  -0.0976  -0.2598
---Overall Test---
        chisquare df       p.value 
pt      "10.775"  " 8.000" " 0.215"
Unstrat "11.463"  " 8.000" " 0.177"
> 
> (xb0 <- xBalance(pr~ date + t1 + t2 + cap + ne + ct + bw + cum.n + strata(pt),
+          data=nuclearplants,
+          report=c("adj.means","adj.mean.diffs",'std.diffs', 'z.scores', 'chisquare.test'))
+ )
      strata        pt                                       Unstrat                                    
      stat   Treatment  Control adj.diff std.diff        z Treatment  Control adj.diff std.diff        z
vars                                                                                                    
date           68.5000  68.4924   0.0979   0.0950   0.2923   68.5000  68.6182  -0.1182  -0.1147  -0.3052
t1             14.0000  13.3953   0.9535   0.2787   0.7918   14.0000  13.6364   0.3636   0.1063   0.2830
t2             69.1000  59.1802   9.3721   0.9894   2.3094   69.1000  59.3182   9.7818   1.0327   2.4674
cap           869.8000 806.4535  66.5698   0.3504   0.9188  869.8000 805.1818  64.6182   0.3401   0.8948
ne              0.2000   0.2442  -0.0233  -0.0522  -0.1445    0.2000   0.2727  -0.0727  -0.1631  -0.4334
ct              0.3000   0.4419  -0.1105  -0.2201  -0.5828    0.3000   0.4545  -0.1545  -0.3080  -0.8121
bw              0.2000   0.1977  -0.0465  -0.1154  -0.3088    0.2000   0.1818   0.0182   0.0451   0.1202
cum.n           8.1000   8.7209  -0.8198  -0.1275  -0.3397    8.1000   8.7273  -0.6273  -0.0976  -0.2598
---Overall Test---
        chisquare df       p.value 
pt      "10.775"  " 8.000" " 0.215"
Unstrat "11.463"  " 8.000" " 0.177"
> ##########################################################################################
> ### Oddness on LHS of formula
> ##########################################################################################Q
> xBalance(I(pr==1) ~ date + t1 + t2 + cap + ne + ct + bw + cum.n + strata(pt),
+          data=nuclearplants,
+          report=c("adj.means","adj.mean.diffs",'std.diffs', 'z.scores', 'chisquare.test')
+          )
      strata        pt                                       Unstrat                                    
      stat   Treatment  Control adj.diff std.diff        z Treatment  Control adj.diff std.diff        z
vars                                                                                                    
date           68.5000  68.4924   0.0979   0.0950   0.2923   68.5000  68.6182  -0.1182  -0.1147  -0.3052
t1             14.0000  13.3953   0.9535   0.2787   0.7918   14.0000  13.6364   0.3636   0.1063   0.2830
t2             69.1000  59.1802   9.3721   0.9894   2.3094   69.1000  59.3182   9.7818   1.0327   2.4674
cap           869.8000 806.4535  66.5698   0.3504   0.9188  869.8000 805.1818  64.6182   0.3401   0.8948
ne              0.2000   0.2442  -0.0233  -0.0522  -0.1445    0.2000   0.2727  -0.0727  -0.1631  -0.4334
ct              0.3000   0.4419  -0.1105  -0.2201  -0.5828    0.3000   0.4545  -0.1545  -0.3080  -0.8121
bw              0.2000   0.1977  -0.0465  -0.1154  -0.3088    0.2000   0.1818   0.0182   0.0451   0.1202
cum.n           8.1000   8.7209  -0.8198  -0.1275  -0.3397    8.1000   8.7273  -0.6273  -0.0976  -0.2598
---Overall Test---
        chisquare df       p.value 
pt      "10.775"  " 8.000" " 0.215"
Unstrat "11.463"  " 8.000" " 0.177"
> 
> 
> #####################################################
> ######               xtable method                ###
> #####################################################
> if (require('xtable'))
+   {
+   xtablea <- xtable(xb0)
+   xtableb <- xtable(xb0, caption="Caption!", label="thetable", digits=1,
+        align=rep('l', prod(dim(xb0$result)[2:3])+1),
+        display=c('s', rep(c(rep('fg', dim(xb0$result)[2]-1), 's'),
+          dim(xb0$result)[3]) ) #,col.labels= do this one later
+        )
+   }
Loading required package: xtable
> 
> 
> #####################################################
> ######               include.means                ###
> #####################################################
> ###xBalance(pr~ date + t1 + t2 + cap + ne + ct + bw + cum.n,
> ###         ~factor(pt), nuclearplants,
> ###         covariate.scaling=1, include.means=TRUE)
> ###xBalance(pr~ date + t1 + t2 + cap + ne + ct + bw + cum.n,
> ###         ~factor(pt), nuclearplants, include.means=TRUE)
> ###
> ###
> #####################################################
> ######  na.rm=FALSE with missing covariates       ###
> #####################################################
> ### Should create a new variable (0=not missing,1=missing) and impute missing values with the mean (median is new default)
> 
> set.seed(123)
> testdata<-nuclearplants
> testdata$date[sample(1:32,10)]<-NA
> 
> xBalance(pr ~ date + t1 + t2 + cap + ne + ct + bw + cum.n, data = testdata,
+     na.rm = FALSE,impfn=mean.default) ##first using the mean to match up with previous versions
             strata  Unstrat        
             stat   std.diff       z
vars                                
date                  0.0209  0.0541
t1                    0.1063  0.2830
t2                    1.0327  2.4674
cap                   0.3401  0.8948
ne                   -0.1631 -0.4334
ct                   -0.3080 -0.8121
bw                    0.0451  0.1202
cum.n                -0.0976 -0.2598
date.NAFALSE          1.0660  2.5308
date.NATRUE          -1.0660 -2.5308
> 
> #####################################################
> ######  handling factor with no obs for a level in a strata  ###
> #####################################################
> 
> testdata<-nuclearplants
> testdata$cum.nF<-factor(testdata$cum.n)
> 
> ##Notice that for most levels of cum.n, there are no obs in one of the two strata
> table(testdata$pt,testdata$cum.n)
   
    1 2 3 5 6 7 8 11 12 14 15 16 17 18 19 20 21
  0 4 3 4 2 1 1 1  0  2  1  1  1  1  1  1  1  1
  1 0 0 0 0 0 1 2  3  0  0  0  0  0  0  0  0  0
> 
> ##    1 2 3 5 6 7 8 11 12 14 15 16 17 18 19 20 21
> ##  0 4 3 4 2 1 1 1  0  2  1  1  1  1  1  1  1  1
> ##  1 0 0 0 0 0 1 2  3  0  0  0  0  0  0  0  0  0
> 
> ##First no missing levels, same in both strata --- looks ok
> xBalance(pr ~ date + t1 + t2 + cap + ne + ct + bw + cum.nF + strata(pt), data = testdata,impfn=mean.default)
         strata       pt          Unstrat        
         stat   std.diff       z std.diff       z
vars                                             
date              0.0950  0.2923  -0.1147 -0.3052
t1                0.2787  0.7918   0.1063  0.2830
t2                0.9894  2.3094   1.0327  2.4674
cap               0.3504  0.9188   0.3401  0.8948
ne               -0.0522 -0.1445  -0.1631 -0.4334
ct               -0.2201 -0.5828  -0.3080 -0.8121
bw               -0.1154 -0.3088   0.0451  0.1202
cum.nF1          -0.0341 -0.0924  -0.1066 -0.2838
cum.nF2           0.0966  0.2610   0.0302  0.0805
cum.nF3          -0.0341 -0.0924  -0.1066 -0.2838
cum.nF5           0.2806  0.7509   0.2194  0.5815
cum.nF6          -0.2282 -0.6070  -0.2548 -0.6742
cum.nF7          -0.4723 -1.1509  -0.3693 -0.9692
cum.nF8           0.3786  0.9460   0.5296  1.3683
cum.nF11          0.2590  0.7454   0.5296  1.3683
cum.nF12          0.2806  0.7509   0.2194  0.5815
cum.nF14         -0.2282 -0.6070  -0.2548 -0.6742
cum.nF15         -0.2282 -0.6070  -0.2548 -0.6742
cum.nF16         -0.2282 -0.6070  -0.2548 -0.6742
cum.nF17         -0.2282 -0.6070  -0.2548 -0.6742
cum.nF18         -0.2282 -0.6070  -0.2548 -0.6742
cum.nF19         -0.2282 -0.6070  -0.2548 -0.6742
cum.nF20          0.6378  1.6475   0.5774  1.4832
cum.nF21         -0.2282 -0.6070  -0.2548 -0.6742
> 
> ##Second two missing levels, same in both strata
> ##This doesn't look as good --- we'd prefer to drop levels that don't exist.
> 
> testdata$cum.nF[testdata$cum.n>16]<-NA
> testdata$cum.nF[testdata$cum.n==7]<-NA
> table(testdata$pt,testdata$cum.nF,exclude=c()) ##Notice that the levels don't disappear by default.
      
       1 2 3 5 6 7 8 11 12 14 15 16 17 18 19 20 21 <NA>
  0    4 3 4 2 1 0 1  0  2  1  1  1  0  0  0  0  0    6
  1    0 0 0 0 0 0 2  3  0  0  0  0  0  0  0  0  0    1
  <NA> 0 0 0 0 0 0 0  0  0  0  0  0  0  0  0  0  0    0
> xBalance(pr ~ date + t1 + t2 + cap + ne + ct + bw + cum.nF + strata(pt), data = testdata,na.rm=FALSE,impfn=mean.default)
          strata       pt          Unstrat        
          stat   std.diff       z std.diff       z
vars                                              
date               0.0950  0.2923  -0.1147 -0.3052
t1                 0.2787  0.7918   0.1063  0.2830
t2                 0.9894  2.3094   1.0327  2.4674
cap                0.3504  0.9188   0.3401  0.8948
ne                -0.0522 -0.1445  -0.1631 -0.4334
ct                -0.2201 -0.5828  -0.3080 -0.8121
bw                -0.1154 -0.3088   0.0451  0.1202
cum.nF1           -0.0341 -0.0924  -0.1066 -0.2838
cum.nF2            0.0966  0.2610   0.0302  0.0805
cum.nF3           -0.0341 -0.0924  -0.1066 -0.2838
cum.nF5            0.2806  0.7509   0.2194  0.5815
cum.nF6           -0.2282 -0.6070  -0.2548 -0.6742
cum.nF7               NaN  0.0000      NaN  0.0000
cum.nF8            0.3786  0.9460   0.5296  1.3683
cum.nF11           0.2590  0.7454   0.5296  1.3683
cum.nF12           0.2806  0.7509   0.2194  0.5815
cum.nF14          -0.2282 -0.6070  -0.2548 -0.6742
cum.nF15          -0.2282 -0.6070  -0.2548 -0.6742
cum.nF16          -0.2282 -0.6070  -0.2548 -0.6742
cum.nF17              NaN  0.0000      NaN  0.0000
cum.nF18              NaN  0.0000      NaN  0.0000
cum.nF19              NaN  0.0000      NaN  0.0000
cum.nF20              NaN  0.0000      NaN  0.0000
cum.nF21              NaN  0.0000      NaN  0.0000
cum.nF.NA         -0.4025 -1.0206  -0.4124 -1.0783
> 
> ##This isn't right either.
> xBalance(pr ~ date + t1 + t2 + cap + ne + ct + bw + cum.nF + strata(pt), data = testdata,na.rm=TRUE,impfn=mean.default)
         strata       pt          Unstrat        
         stat   std.diff       z std.diff       z
vars                                             
date              0.1674  0.4662  -0.1063 -0.2602
t1                0.3977  0.9554   0.2266  0.5520
t2                0.8602  1.8952   0.9463  2.0968
cap               0.4874  1.1309   0.4748  1.1324
ne               -0.3416 -0.8303  -0.4643 -1.1088
ct                0.1111  0.2868  -0.0833 -0.2041
bw               -0.2913 -0.7283  -0.0624 -0.1529
cum.nF1          -0.0974 -0.2378  -0.2009 -0.4900
cum.nF2           0.0547  0.1332  -0.0410 -0.1005
cum.nF3          -0.0974 -0.2378  -0.2009 -0.4900
cum.nF5           0.2629  0.6341   0.1725  0.4214
cum.nF6          -0.2752 -0.6547  -0.3096 -0.7500
cum.nF7              NaN  0.0000      NaN  0.0000
cum.nF8           0.2812  0.6623   0.4851  1.1558
cum.nF11          0.1125  0.3333   0.4851  1.1558
cum.nF12          0.2629  0.6341   0.1725  0.4214
cum.nF14         -0.2752 -0.6547  -0.3096 -0.7500
cum.nF15         -0.2752 -0.6547  -0.3096 -0.7500
cum.nF16         -0.2752 -0.6547  -0.3096 -0.7500
cum.nF17             NaN  0.0000      NaN  0.0000
cum.nF18             NaN  0.0000      NaN  0.0000
cum.nF19             NaN  0.0000      NaN  0.0000
cum.nF20             NaN  0.0000      NaN  0.0000
cum.nF21             NaN  0.0000      NaN  0.0000
> 
> 
> #####################################################
> ######  handling factor with no levels strata=argument  ###
> #####################################################
> testdata$badStrat <- rep(NA, dim(testdata)[1])
> try(xBalance(pr ~ date + strata(badStrat),
+              data=testdata), FALSE)
Error in makeDesign(fmla, data, imputefn = impfn, na.rm = na.rm) : 
  All levels in strata(badStrat) are NA
> 
> #####################################################
> ######             WISHLIST                       ###
> #####################################################
> ###
> ###
> ###
> ###
> 
> proc.time()
   user  system elapsed 
  1.666   0.043   1.697 
